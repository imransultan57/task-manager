<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <div class="d-flex justify-content-between mb-4">
    <h1>Tasks</h1>
    <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
  </div>
  <form id="taskForm" class="card p-3 mb-4 shadow-sm">
    <input type="text" id="title" class="form-control mb-2" placeholder="Title" required>
    <textarea id="description" class="form-control mb-2" placeholder="Description" required></textarea>
    <button type="submit" class="btn btn-primary w-100">Add Task</button>
  </form>
  <div id="taskList" class="list-group"></div>
</div>

<script>
const API_URL = "http://localhost:8090/tasks";
const token = localStorage.getItem("token");
if (!token) window.location.href="/login";
const headers = {"Content-Type":"application/json","Authorization":"Bearer "+token};

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("token");
  window.location.href="/login";
});

async function fetchTasks() {
  const res = await fetch(API_URL, {headers});
  if(res.status===401){localStorage.removeItem("token");window.location.href="/login";return;}
  const tasks = await res.json();
  const list = document.getElementById("taskList"); 
  list.innerHTML="";
  tasks.forEach(t=>{
    const item = document.createElement("div"); 
    item.className="list-group-item";

    item.innerHTML = `
      <div id="view-${t.id}" class="d-flex justify-content-between align-items-start">
        <div>
          <h5>${t.title}</h5>
          <p>${t.description}</p>
          <small>${t.completed?"‚úÖ Completed":"‚è≥ Pending"}</small>
        </div>
        <div>
          <button class="btn btn-success btn-sm me-2" onclick="toggleComplete('${t.id}', ${!t.completed})">‚úî</button>
          <button class="btn btn-warning btn-sm me-2" onclick="editTask('${t.id}','${t.title}','${t.description}')">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteTask('${t.id}')">üóë</button>
        </div>
      </div>
      <form id="edit-${t.id}" class="d-none mt-2">
        <input type="text" id="edit-title-${t.id}" class="form-control mb-1" value="${t.title}" required>
        <textarea id="edit-desc-${t.id}" class="form-control mb-1" rows="2" required>${t.description}</textarea>
        <button type="button" class="btn btn-primary btn-sm me-1" onclick="updateTask('${t.id}')">üíæ Save</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEdit('${t.id}')">‚ùå Cancel</button>
      </form>
    `;
    list.appendChild(item);
  });
}

// Add Task
async function addTask(e){
  e.preventDefault();
  const title = document.getElementById("title").value;
  const description = document.getElementById("description").value;
  await fetch(API_URL,{method:"POST",headers,body:JSON.stringify({title,description,completed:false})});
  e.target.reset(); fetchTasks();
}

// Delete Task
async function deleteTask(id){
  await fetch(`${API_URL}/${id}`,{method:"DELETE",headers});
  fetchTasks();
}

// Toggle Complete
async function toggleComplete(id,completed){
  await fetch(`${API_URL}/${id}`,{method:"PUT",headers,body:JSON.stringify({completed})});
  fetchTasks();
}

// Edit / Cancel / Update
function editTask(id,title,desc){
  document.getElementById(`view-${id}`).classList.add("d-none");
  document.getElementById(`edit-${id}`).classList.remove("d-none");
}
function cancelEdit(id){
  document.getElementById(`edit-${id}`).classList.add("d-none");
  document.getElementById(`view-${id}`).classList.remove("d-none");
}
async function updateTask(id){
  const title = document.getElementById(`edit-title-${id}`).value;
  const description = document.getElementById(`edit-desc-${id}`).value;
  await fetch(`${API_URL}/${id}`,{method:"PUT",headers,body:JSON.stringify({title,description})});
  fetchTasks();
}

// Form submit
document.getElementById("taskForm").addEventListener("submit",addTask);
fetchTasks();
</script>
</body>
</html>
